name: sort-strucvars
description: Sort structural variant files

runs:
  using: "composite"
  steps:
    - name: Get ClinVar version
      id: get-clinvar
      run: echo "clinvar-release=$(cat clinvar-release.txt || echo 00-latest_weekly)" >> $GITHUB_OUTPUT
      # cf. https://github.com/mamba-org/provision-with-micromamba#important
      shell: bash -l {0}

    - name: Get current date
      id: get-today
      run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      # cf. https://github.com/mamba-org/provision-with-micromamba#important
      shell: bash -l {0}

    - name: Check cache sorting output
      id: check-cache-sort-output
      uses: actions/cache@v3
      with:
        path: ${{ env.OUTPUT_DIR }}/${{ matrix.genome_release }}/strucvar/sorted
        key: sort-strucvars-${{ steps.get-clinvar.outputs.clinvar-release }}-${{ env.CLINVAR_TSV_VERSION }}-${{ env.MAX_RCVS }}-${{ matrix.genome_release }}
        lookup-only: true

    - name: Install Conda environment
      if: steps.check-cache-sort-output.outputs.cache-hit != 'true'
      uses: mamba-org/setup-micromamba@v1
      with:
        cache-environment: true
        environment-name: annonars-data-clinvar
        condarc: |
          channels:
            - conda-forge
            - bioconda
            - defaults
        create-args: >-
          samtools
          htslib

    - name: Cache sorting output
      if: steps.check-cache-sort-output.outputs.cache-hit != 'true'
      uses: actions/cache@v3
      with:
        path: ${{ env.OUTPUT_DIR }}/${{ matrix.genome_release }}/strucvar/sorted
        key: sort-strucvars-${{ steps.get-clinvar.outputs.clinvar-release }}-${{ env.CLINVAR_TSV_VERSION }}-${{ env.MAX_RCVS }}-${{ matrix.genome_release }}

    - name: Retrieve conversion output cache
      if: steps.check-cache-sort-output.outputs.cache-hit != 'true'
      uses: actions/cache@v3
      with:
        path: ${{ env.OUTPUT_DIR }}/${{ matrix.genome_release }}/strucvar/parsed
        key: convert-clinvar-${{ steps.get-clinvar.outputs.clinvar-release }}-${{ env.CLINVAR_TSV_VERSION }}-${{ env.MAX_RCVS }}-${{ matrix.genome_release }}-strucvar
        fail-on-cache-miss: true

    - name: Run the sorting
      if: steps.check-cache-sort-output.outputs.cache-hit != 'true'
      run: bash .github/actions/sort-strucvars/run.sh
      env:
        GENOME_RELEASE: "${{ matrix.genome_release }}"
      # cf. https://github.com/mamba-org/provision-with-micromamba#important
      shell: bash -l {0}
